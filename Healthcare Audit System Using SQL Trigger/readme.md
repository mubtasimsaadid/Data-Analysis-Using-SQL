# Healthcare Audit System using SQL Trigger 

A comprehensive SQL trigger-based audit trail system designed for healthcare databases, ensuring HIPAA compliance, data integrity, and complete accountability for all patient record modifications.

## Overview

This project implements an automated audit logging system using SQL triggers to track all data modifications (INSERT, UPDATE, DELETE) in a healthcare database. Every change to patient information and medical records is automatically logged with timestamps, user identification, and complete change history.


## Database Setup

- Create a database named `healthcare`.
```sql
CREATE DATABASE IF NOT EXISTS HEALTHCARE;
USE HEALTHCARE;
```

## Core Tables 
PATIENTS 
```sql
CREATE TABLE PATIENTS(
	PATIENT_ID BIGINT AUTO_INCREMENT PRIMARY KEY,
    FULL_NAME VARCHAR(50) NOT NULL,
    DOB DATE,
    GENDER CHAR(1),
    EMAIL VARCHAR(50),
    ADDRESS VARCHAR (200),
    LAST_TREATMENT_DATE DATETIME,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP);
```
MEDICAL_RECORDS 
```sql
CREATE TABLE MEDICAL_RECORDS(
	RECORD_ID BIGINT AUTO_INCREMENT PRIMARY KEY,
    PATIENT_ID INT,
    DIAGNOSIS VARCHAR(100),
    TREATMENT VARCHAR(100), 
    PRESCRIBED_BY VARCHAR(50),
    RECORD_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP);
```
AUDIT_LOG
```sql
CREATE TABLE AUDIT_LOG (
	LOG_ID BIGINT AUTO_INCREMENT PRIMARY KEY,
    TABLE_NAME VARCHAR(50),					  -- FROM WHICH TABLE THE DATA HAS BEEN CHANGED 
    ACTION_TYPE VARCHAR(20), 				  -- INSERT, UPDATE, DELETE		
    ENTITY_ID BIGINT NOT NULL,				-- REFERENCE ID OF PATIENT_ID & RECORD_ID
    CHANGED_DATA JSON,                -- STORES OLD AND CHANGED DATA IN JSON FORMAT
    CHANGED_BY INT, 						      -- ID OF WHOM HAS CHANGED THE DATA
    ACTION_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
```
## SETTING CURRENT USER
```sql
SET @CURRENT_CHANGED_BY = 1101;           -- MANUALLY SET CHANGED_BY ID 
```

## TRIGGER IMPLEMENTATION
INSERT TRIGGER: Automatically log new patient registrations and medical record creation:
```sql
TRIGGER 
DELIMITER $$
CREATE TRIGGER patientsinfo_after_insert
AFTER INSERT ON PATIENTS 
FOR EACH ROW BEGIN
    INSERT INTO AUDIT_LOG (TABLE_NAME, ACTION_TYPE, ENTITY_ID, CHANGED_DATA, CHANGED_BY, ACTION_DATE)
    VALUES(
	'PATIENTS','INSERT',
	NEW.PATIENT_ID,
    JSON_OBJECT('FULL_NAME', NEW.FULL_NAME, 'DOB', NEW.DOB, ...),
    IFNULL(@CURRENT_CHANGED_BY, 0),
    NOW()
    );
END $$
DELIMITER ;
```

UPDATE TRIGGER: When any existing record is updated, triggers captures both old and new values for comparison.
```sql
TRIGGER 
DELIMITER $$
CREATE TRIGGER medicalrecords_after_update
AFTER INSERT ON MEDICAL_RECORDS 
FOR EACH ROW BEGIN
	IF NOT (OLD.RECORD_ID <=> NEW.RECORD_ID AND ...)
	THEN INSERT INTO AUDIT_LOG (TABLE_NAME, ACTION_TYPE, ENTITY_ID, CHANGED_DATA, CHANGED_BY, ACTION_DATE)
    VALUES(
	'MEDICAL_RECORDS',
	'UPDATE',
	OLD.RECORD_ID,
	JSON_OBJECT('OLD: ', JSON_OBJECT('PATIENT_ID', OLD.PATIENT_ID, 'DIAGNOSIS', OLD.DIAGNOSIS, ....),
	'NEW: ', JSON_OBJECT('PATIENT_ID', NEW.PATIENT_ID, 'DIAGNOSIS', NEW.DIAGNOSIS, ....)),
    IFNULL(@CURRENT_CHANGED_BY, 0),
    NOW()
    );
	END IF;
END $$
DELIMITER ;
```

DELETE TRIGGER: Preserve deleted data for auditing and rollbacks
```sql
CREATE TABLE PATIENTS(
	PATIENT_ID BIGINT AUTO_INCREMENT PRIMARY KEY,
    FULL_NAME VARCHAR(50) NOT NULL,
    DOB DATE,
    GENDER CHAR(1),
    EMAIL VARCHAR(50),
    ADDRESS VARCHAR (200),
    LAST_TREATMENT_DATE DATETIME,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP);
```

